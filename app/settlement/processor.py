import pandas as pd

# -------------------------------------------------------
# 1) í‘œì¤€ ì»¬ëŸ¼ ìƒì„±
# -------------------------------------------------------

def normalize_columns(df: pd.DataFrame, company: str) -> pd.DataFrame:
    """ì¹´ì¹´ì˜¤/KT/ë„¤ì´ë²„ íŒŒì¼ì„ ëª¨ë‘ ë™ì¼í•œ í‘œì¤€ ì»¬ëŸ¼ êµ¬ì¡°ë¡œ ë³€í™˜"""
    df = df.copy()
    cols = df.columns

    # í‘œì¤€ ì»¬ëŸ¼ ì´ˆê¸°í™”
    df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = 0
    df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = 0
    df["ì´ê¸ˆì•¡_í‘œì¤€"] = 0

    # ---------------------------
    # ğŸ”¹ Kakao ë§¤í•‘
    # ---------------------------
    if company == "kakao":
        if "ì•Œë¦¼ ìˆ˜ì‹  ê±´ìˆ˜" in cols:
            df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = df["ì•Œë¦¼ ìˆ˜ì‹  ê±´ìˆ˜"]

        # ì¸ì¦ê±´ìˆ˜: ì—´ëŒ ì‹œ ì¸ì¦ > ì—´ëŒê±´ìˆ˜
        if "ì—´ëŒ ì‹œ ì¸ì¦ ê±´ìˆ˜" in cols:
            df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = df["ì—´ëŒ ì‹œ ì¸ì¦ ê±´ìˆ˜"]
        elif "ì—´ëŒ ê±´ìˆ˜" in cols:
            df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = df["ì—´ëŒ ê±´ìˆ˜"]

        if "ì´ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ì´ê¸ˆì•¡"]
        elif "ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ê¸ˆì•¡"]

    # ---------------------------
    # ğŸ”¹ KT ë§¤í•‘
    # ---------------------------
    elif company == "kt":

        # auto ìˆ˜ì‹ ê±´ìˆ˜ + ì—´ëŒê±´ìˆ˜
        if "ìˆ˜ì‹ ê±´ìˆ˜" in cols and "ì—´ëŒê±´ìˆ˜" in cols:
            df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = df["ìˆ˜ì‹ ê±´ìˆ˜"] + df["ì—´ëŒê±´ìˆ˜"]

        elif "ë°œì†¡ìš”ì²­ê±´" in cols:
            df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = df["ë°œì†¡ìš”ì²­ê±´"]

        # ì¸ì¦ê±´ìˆ˜ = ì—´ëŒê±´ìˆ˜
        if "ì—´ëŒê±´ìˆ˜" in cols:
            df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = df["ì—´ëŒê±´ìˆ˜"]

        if "ì´ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ì´ê¸ˆì•¡"]
        elif "ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ê¸ˆì•¡"]

    # ---------------------------
    # ğŸ”¹ Naver ë§¤í•‘
    # ---------------------------
    elif company == "naver":

        if "ë°œì†¡ê±´ìˆ˜" in cols:
            df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = df["ë°œì†¡ê±´ìˆ˜"]

        if "ì—´ëŒê±´ìˆ˜" in cols:
            df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = df["ì—´ëŒê±´ìˆ˜"]

        if "ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ê¸ˆì•¡"]
        elif "ì´ê¸ˆì•¡" in cols:
            df["ì´ê¸ˆì•¡_í‘œì¤€"] = df["ì´ê¸ˆì•¡"]

    return df


# -------------------------------------------------------
# 2) ì‚¬í›„ ì •ë¦¬: í…ŒìŠ¤íŠ¸ë°ì´í„° ì œê±° + ìŒìˆ˜/ê²°ì¸¡ ì²˜ë¦¬
# -------------------------------------------------------

def post_process(df: pd.DataFrame, company: str) -> pd.DataFrame:
    df = df.copy()

    # ì¹´ì¹´ì˜¤ í…ŒìŠ¤íŠ¸ D10_2T, D11_2T ì œê±°
    if company == "kakao" and "ìƒí’ˆ" in df.columns:
        df = df[~df["ìƒí’ˆ"].astype(str).str.contains("T")]

    # ìˆ˜ì¹˜í˜• ë³€í™˜
    df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"] = pd.to_numeric(df["ë°œì†¡ê±´ìˆ˜_í‘œì¤€"], errors="coerce").fillna(0).clip(lower=0)
    df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"] = pd.to_numeric(df["ì¸ì¦ê±´ìˆ˜_í‘œì¤€"], errors="coerce").fillna(0).clip(lower=0)
    df["ì´ê¸ˆì•¡_í‘œì¤€"] = pd.to_numeric(df["ì´ê¸ˆì•¡_í‘œì¤€"], errors="coerce").fillna(0).clip(lower=0)

    return df


# -------------------------------------------------------
# 3) ìµœì¢… ì²˜ë¦¬ í•¨ìˆ˜
# -------------------------------------------------------

def process_file(df: pd.DataFrame, company: str) -> pd.DataFrame:
    """í‘œì¤€í™” + í…ŒìŠ¤íŠ¸ì œê±° + ì‚¬í›„ì •ë¦¬ê¹Œì§€ í•œ ë²ˆì— ì²˜ë¦¬"""

    df = normalize_columns(df, company)
    df = post_process(df, company)
    df["ì •ì‚°íšŒì‚¬"] = company

    return df
